<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/papaparse.js"></script>
    <script src="/js/d3.js"></script>
    <title>oi</title>
    <style>
      body {padding: 0; margin: 0;}
      canvas {vertical-align: top;}
    </style>
  </head>
  <body>

    <script>
      var d = [];
      Papa.parse("tweets_classificados.csv", {
        download: true,
        header: true,
        complete: function(results) {
          d = results;
          monta_array();
        }
      });

      function conv_valencia(val) {
        return (val - 4)/3; // de -1 a 1
      }

      function conv_intensidade(inten) {
        return (inten - 1)/6; // de 0 a 1
      }

      var historico = [];

      function monta_array(user = null) {

        if (!user) {
          user = d.data[0].id;
        }

        var i = 0, terminou = false;
        var s_i_1 = s_i = null;
        while (!terminou) {
          if (i == d.data.length || d.data[i].id != user) {
            terminou = true;
          } else {

            historico.push({});

            if (s_i === null) { // primeiro loop 
              historico[i]["delta_t"] = 0;
              s_i = Date.parse(d.data[i].data);
            } else {

              s_i_1 = s_i;
              s_i = Date.parse(d.data[i].data);
              delta_t = s_i_1 - s_i; // qtos segundos entre eles?
              historico[i]["delta_t"] = delta_t;
            }

            historico[i]["valencia"] = conv_valencia(d.data[i].val);
            historico[i]["intensidade"] = conv_intensidade(d.data[i].int);
            
            i++;
          }
        }

        desenha();

      } 

      // ref: d3.min; d3.max; d3.extent [min e max]
      // d3.sum; d3.mean; d3.median; d3.shuffle


      function desenha() {

        var width = 500;
        var height = 8000;

        var time_scale = d3.scaleLinear()
                          .domain([0, d3.max(historico.map(function(d){return d.delta_t;}))])
                          .range([10, 100]);

        var intensity_scale = d3.scaleLinear()
                                .domain([0, 1])
                                .range([1, 15]);
                                
        var valence_color_scale = d3.scaleLinear()
                                    .domain([-1,0,1])
                                    .range(["red","rgb(128,128,128)","green"]);

        var canvas = d3.select("body")
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height);

        var circs = canvas.selectAll("circs")
                    .data(historico)
                    .enter()
                      .append("circle")
                      .attr("cx", 50)
                      .attr("cy", function(d, i) {
                          return time_scale(d.delta_t) * i + 100;
                        })
                      .attr("r",function(d) {
                          return intensity_scale(d.intensidade);
                        })
                      .attr("fill",function(d) {
                        return valence_color_scale(d.valencia);
                      });

        
      }



        // var color = d3.scaleLinear()
        //               .domain([0, 60])
        //               .range(["red", "blue"]);

        // var xAxis = d3.axisBottom()
        //             .ticks(5)
        //             .scale(widthScale);
        


      // var bars = canvas.selectAll("rect")
      //             .data(dataArray)
      //             .enter()
      //               .append("rect")
      //               .attr("width", function(d) { return widthScale(d); })
      //               .attr("height", 50)
      //               .attr("fill", function(d) { return color(d); })
      //               .attr("y", function(d, i) { return i * 100; });

      // canvas.append("g")
      //   .attr("transform", "translate(0, 400)")
      //   .call(xAxis);


      // duvida: h√° blur para svg??


    </script>
  </body>
</html>